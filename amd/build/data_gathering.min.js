define(["jquery"],function(a){var b=!1,c=!1,d=0,e=[],f={autosavetime:0,enablescreenshot:!1,showpredictionpoint:!1,showvideocanvas:!1};return{setParameters:function(a,b,c,d){f.autosavetime=a,f.enablescreenshot=b,f.showpredictionpoint=c,f.showvideocanvas=d},setLibraries:function(a,b){webgazer.setTracker(a),webgazer.setRegression(b)},init:function(g,h){var i=function(){function d(){requestAnimFrame(d),o.getContext("2d").clearRect(0,0,e,j),p.getCurrentPosition()&&p.draw(o)}if(webgazer.isReady()){if(!c){if(f.showvideocanvas){var e=160,j=120,k="0px",l="0px",m=document.getElementById("webgazerVideoDiv");m.style.position="relative",a("#webgazerVideoFeed").appendTo("#webgazerVideoDiv");var n=document.getElementById("webgazerVideoFeed");n.style.display="block",n.style.position="absolute",n.style.top=k,n.style.left=l,n.width=e,n.height=j,n.style.margin="0px",webgazer.params.imgWidth=e,webgazer.params.imgHeight=j;var o=document.createElement("canvas");o.id="webgazerOverlay",document.body.appendChild(o),a("#webgazerOverlay").appendTo("#webgazerVideoDiv"),o.style.position="absolute",o.width=e,o.height=j,o.style.top=k,o.style.left=l,o.style.margin="0px";var p=webgazer.getTracker().clm;d()}else a("#webgazerVideoText").text("Webgazer initialized!");c=!0,!b&&f.enablescreenshot&&(html2canvas(document.body,{onrendered:function(b){console.log("img: "+b.toDataURL("image/jpeg")),a.ajax({url:h,data:{sessionid:g,action:"savescreenshot",screenshot:b.toDataURL("image/jpeg",.5)},method:"POST"}).done(function(a){console.log("savescreenshot: "+a)})}}),b=!0)}}else setTimeout(i,100)},j=function(){var b=arguments.length<1||1==arguments[0];console.log("resume: "+b+" - arguments: "+arguments),webgazer.pause(),a.ajax({url:h,data:{sessionid:g,action:"savegazerdata",gazerdata:e},method:"POST"}).done(function(a){e=[],b&&webgazer.resume()}).fail(function(){b&&webgazer.resume()}).always(function(){b&&webgazer.resume()})};a(window).blur(function(){webgazer.pause(),j(!1)}),a(window).unload(function(){webgazer.pause(),j(!1)}),a(window).focus(function(){i(),webgazer.resume()}),a(window).load(function(){return a("#webgazerVideoText").text("You need a compatible browser and webcam to gather data!"),webgazer.detectCompatibility()?(webgazer.setGazeListener(function(a,b){if(null!=a){var c=a.x+window.pageXOffset,g=a.y+window.pageYOffset;e.push({x:c,y:g,time:b}),f.autosavetime>0&&b-d>f.autosavetime&&(d=b,j())}}).begin(function(){a("#webgazerVideoText").text("You need a webcam to use webgazer!")}).showPredictionPoints(f.showpredictionpoint),void setTimeout(i,100)):void a("#webgazerVideoText").text("Your browser is inconpatible with webgazer!")})}}});