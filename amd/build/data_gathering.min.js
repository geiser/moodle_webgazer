define(["jquery"],function(a){var b=[],c=0,d={autosavetime:0,enablescreenshot:!1,showpredictionpoint:!1,showvideocanvas:!1};return{setParameters:function(a,b,c,e){d.autosavetime=a,d.enablescreenshot=b,d.showpredictionpoint=c,d.showvideocanvas=e},setLibraries:function(a,b){webgazer.setTracker(a),webgazer.setRegression(b)},init:function(e,f){var g=function(){html2canvas(document.body,{onrendered:function(b){a.ajax({url:f,data:{sessionid:e,action:"savescreenshot",screenshot:b.toDataURL("image/jpeg",.5)},method:"POST"}).done(function(a){})}})},h=function(){function a(){requestAnimFrame(a),j.getContext("2d").clearRect(0,0,b,c),k.getCurrentPosition()&&k.draw(j)}var b=160,c=120,e="0px",f="0px",g=document.getElementById("webgazerVideoDiv");if(!webgazer.isReady()||d.enablescreenshot&&(void 0==g||null==g))return void setTimeout(h,500);g.style.position="relative";var i=document.getElementById("webgazerVideoFeed");g.appendChild(i),i.style.display="block",i.style.position="absolute",i.style.top=e,i.style.left=f,i.width=b,i.height=c,i.style.margin="0px",webgazer.params.imgWidth=b,webgazer.params.imgHeight=c;var j=document.createElement("canvas");j.id="webgazerOverlay",j.style.position="absolute",j.width=b,j.height=c,j.style.top=e,j.style.left=f,j.style.margin="0px",document.body.appendChild(j),g.appendChild(j);var k=webgazer.getTracker().clm;a()},i=function(){c=a.now(),a(document).mousemove(function(d){if(void 0==webgazer||!webgazer.isReady()){var e=a.now()-c;e*=-1,b.push({x:d.pageX,y:d.pageY,time:e})}})},j=function(d){b.length>0&&(0==c&&webgazer.pause(),a.ajax({url:f,data:{sessionid:e,action:"savegazerdata",gazerdata:b},method:"POST"}).done(function(a){b=[],d()}).fail(function(){d()}))},k=function(){j(function(){0==c&&webgazer.resume()}),setTimeout(k,d.autosavetime)};a(window).blur(function(){j(function(){})}),a(window).unload(function(){j(function(){})}),a(window).focus(function(){0==c&&webgazer.resume()}),a(window).load(function(){if(d.enablescreenshot&&g(),webgazer.detectCompatibility()||(a("#webgazerVideoText").text("Your browser is inconpatible with webgazer! So, we are using mouse position as webgazer."),i()),webgazer.setGazeListener(function(a,c){if(null!=a){var d=a.x+window.pageXOffset,e=a.y+window.pageYOffset;b.push({x:d,y:e,time:c})}}).begin(function(){a("#webgazerVideoText").text("You need a webcam to use webgazer! So, we are using mouse position as webgazer."),i()}).showPredictionPoints(d.showpredictionpoint),d.showvideocanvas)setTimeout(h,500);else{var c=function(){return webgazer.isReady()?void a("#webgazerVideoText").text("Webgazer initialized!"):void setTimeout(c,500)};c()}d.autosavetime>0&&k()})}}});